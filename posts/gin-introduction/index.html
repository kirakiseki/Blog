<!doctype html><html><head><title>Gin 快速上手</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="一些Gin的基础用法"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script>
<link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.c5d92f380bf10f6849c7ac487c7df2b22c081e0851e5339224f1ae29210b20d2.css integrity="sha256-xdkvOAvxD2hJx6xIfH3ysiwIHghR5TOSJPGuKSELINI=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.9f8d8c2df9285089d141edd4a50cb7506c7948e6ab79a29968dced1bd0ab7d22.css integrity="sha256-n42MLfkoUInRQe3UpQy3UGx5SOareaKZaNztG9CrfSI=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"><script>console.log("Hello from 'layouts/partials/extended_head.html'")</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://ishirai.com><div class=nav-title>Ishirai's Blog</div><div class=nav-subtitle>Pause and Ponder.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Ishirai CC-BY-NC 4.0</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- 目录 -</center><ul><li><a href=#0x00-%e5%ae%89%e8%a3%85 onclick="onNavClick(`#0x00-安装-nav`)" id=0x00-安装-nav>0x00 安装</a></li><li><a href=#0x01-%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b onclick="onNavClick(`#0x01-快速开始-nav`)" id=0x01-快速开始-nav>0x01 快速开始</a></li><ul><li><a href=#%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1%e5%99%a8 onclick="onNavClick(`#创建服务器-nav`)" id=创建服务器-nav>创建服务器</a></li><li><a href=#%e7%ac%ac%e4%b8%80%e4%b8%aa%e6%9c%8d%e5%8a%a1 onclick="onNavClick(`#第一个服务-nav`)" id=第一个服务-nav>第一个服务</a></li></ul><li><a href=#0x02-%e6%9c%8d%e5%8a%a1%e6%96%b9%e5%bc%8f onclick="onNavClick(`#0x02-服务方式-nav`)" id=0x02-服务方式-nav>0x02 服务方式</a></li><ul><li><a href=#restful-api onclick="onNavClick(`#restful-api-nav`)" id=restful-api-nav>RESTful API</a></li><li><a href=#%e8%bf%94%e5%9b%9e%e9%9d%99%e6%80%81%e9%a1%b5%e9%9d%a2 onclick="onNavClick(`#返回静态页面-nav`)" id=返回静态页面-nav>返回静态页面</a></li></ul><li><a href=#0x03-%e5%8f%82%e6%95%b0%e4%bc%a0%e9%80%92 onclick="onNavClick(`#0x03-参数传递-nav`)" id=0x03-参数传递-nav>0x03 参数传递</a></li><ul><li><a href=#%e9%97%ae%e5%8f%b7%e4%bc%a0%e5%8f%82 onclick="onNavClick(`#问号传参-nav`)" id=问号传参-nav>问号传参</a></li><li><a href=#restful-api-1 onclick="onNavClick(`#restful-api-1-nav`)" id=restful-api-1-nav>RESTful API</a></li><li><a href=#%e5%ba%8f%e5%88%97%e5%8c%96%e5%af%b9%e8%b1%a1 onclick="onNavClick(`#序列化对象-nav`)" id=序列化对象-nav>序列化对象</a></li><li><a href=#post%e8%a1%a8%e5%8d%95 onclick="onNavClick(`#post表单-nav`)" id=post表单-nav>POST表单</a></li></ul><li><a href=#0x04-%e9%87%8d%e5%ae%9a%e5%90%91 onclick="onNavClick(`#0x04-重定向-nav`)" id=0x04-重定向-nav>0x04 重定向</a></li><li><a href=#0x05-404%e9%a1%b5%e9%9d%a2 onclick="onNavClick(`#0x05-404页面-nav`)" id=0x05-404页面-nav>0x05 404页面</a></li><li><a href=#0x06-%e8%b7%af%e7%94%b1%e7%bb%84 onclick="onNavClick(`#0x06-路由组-nav`)" id=0x06-路由组-nav>0x06 路由组</a></li><li><a href=#0x07-%e4%b8%ad%e9%97%b4%e4%bb%b6 onclick="onNavClick(`#0x07-中间件-nav`)" id=0x07-中间件-nav>0x07 中间件</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- 目录 -</center><ul><li><a href=#0x00-%e5%ae%89%e8%a3%85 onclick="onNavClick(`#0x00-安装-nav`)" id=0x00-安装-nav>0x00 安装</a></li><li><a href=#0x01-%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b onclick="onNavClick(`#0x01-快速开始-nav`)" id=0x01-快速开始-nav>0x01 快速开始</a></li><ul><li><a href=#%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1%e5%99%a8 onclick="onNavClick(`#创建服务器-nav`)" id=创建服务器-nav>创建服务器</a></li><li><a href=#%e7%ac%ac%e4%b8%80%e4%b8%aa%e6%9c%8d%e5%8a%a1 onclick="onNavClick(`#第一个服务-nav`)" id=第一个服务-nav>第一个服务</a></li></ul><li><a href=#0x02-%e6%9c%8d%e5%8a%a1%e6%96%b9%e5%bc%8f onclick="onNavClick(`#0x02-服务方式-nav`)" id=0x02-服务方式-nav>0x02 服务方式</a></li><ul><li><a href=#restful-api onclick="onNavClick(`#restful-api-nav`)" id=restful-api-nav>RESTful API</a></li><li><a href=#%e8%bf%94%e5%9b%9e%e9%9d%99%e6%80%81%e9%a1%b5%e9%9d%a2 onclick="onNavClick(`#返回静态页面-nav`)" id=返回静态页面-nav>返回静态页面</a></li></ul><li><a href=#0x03-%e5%8f%82%e6%95%b0%e4%bc%a0%e9%80%92 onclick="onNavClick(`#0x03-参数传递-nav`)" id=0x03-参数传递-nav>0x03 参数传递</a></li><ul><li><a href=#%e9%97%ae%e5%8f%b7%e4%bc%a0%e5%8f%82 onclick="onNavClick(`#问号传参-nav`)" id=问号传参-nav>问号传参</a></li><li><a href=#restful-api-1 onclick="onNavClick(`#restful-api-1-nav`)" id=restful-api-1-nav>RESTful API</a></li><li><a href=#%e5%ba%8f%e5%88%97%e5%8c%96%e5%af%b9%e8%b1%a1 onclick="onNavClick(`#序列化对象-nav`)" id=序列化对象-nav>序列化对象</a></li><li><a href=#post%e8%a1%a8%e5%8d%95 onclick="onNavClick(`#post表单-nav`)" id=post表单-nav>POST表单</a></li></ul><li><a href=#0x04-%e9%87%8d%e5%ae%9a%e5%90%91 onclick="onNavClick(`#0x04-重定向-nav`)" id=0x04-重定向-nav>0x04 重定向</a></li><li><a href=#0x05-404%e9%a1%b5%e9%9d%a2 onclick="onNavClick(`#0x05-404页面-nav`)" id=0x05-404页面-nav>0x05 404页面</a></li><li><a href=#0x06-%e8%b7%af%e7%94%b1%e7%bb%84 onclick="onNavClick(`#0x06-路由组-nav`)" id=0x06-路由组-nav>0x06 路由组</a></li><li><a href=#0x07-%e4%b8%ad%e9%97%b4%e4%bb%b6 onclick="onNavClick(`#0x07-中间件-nav`)" id=0x07-中间件-nav>0x07 中间件</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://ishirai.com>Ishirai's Blog</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://ishirai.com><div class=single-column-header-title>Ishirai's Blog</div><div class=single-column-header-subtitle>Pause and Ponder.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Gin 快速上手<div class=post-subtitle>一些Gin的基础用法</div><div class=post-meta><time itemprop=datePublished>2023-01-14 00:03</time>
<i class=material-icons>folder</i>
<a href=/categories/golang>Golang</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/golang>Golang</a>
&nbsp;
<a href=/tags/gin>Gin</a>
&nbsp;
<i class=material-icons>schedule</i>
14 min
13 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=0x00-安装>0x00 安装</h1><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go get -u github.com/gin-gonic/gin <span style=color:#7f848e># Install Gin</span>
</span></span></code></pre></div><h1 id=0x01-快速开始>0x01 快速开始</h1><h2 id=创建服务器>创建服务器</h2><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>main</span>(){
</span></span><span style=display:flex><span>  <span style=color:#e06c75>ginServer</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>gin</span>.<span style=color:#61afef;font-weight:700>Default</span>()
</span></span><span style=display:flex><span>  <span style=color:#e06c75>_</span> = <span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>Run</span>(<span style=color:#98c379>&#34;:8080&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>gin.Default()</code>使用默认设置定义服务器，使用<code>server.Run(":8080")</code>来指定运行的端口。</p><p><code>server.Run</code>函数原型:</p><p><code>func (engine *Engine) Run(addr ...string) (err error)</code></p><p>使用<code>:8080</code>传入<code>addr ...string</code>指定端口。返回的err非致命，不处理也行。</p><p>如何处理error：</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>Run</span>(<span style=color:#98c379>&#34;:8080&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=第一个服务>第一个服务</h2><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// GET /hello
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/hello&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;hello world&#34;</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>定义服务的方法：</p><p><code>server.METHOD(path string, handler ...gin.HandlerFunc)</code>，此处的handler接收一个<code>*gin.Context</code>参数对象，其中包含请求内容等。在handler中，使用传入的context参数做对应的请求Request解析及响应Response。</p><p>使用<code>ctx.JSON</code>响应一个JSON对象。函数原型:</p><p><code>func (c *Context) JSON(code int, obj any)</code></p><p>在JSON函数中实现响应操作，返回内容为状态码为code，以及序列化为JSON后的obj。</p><p>状态码可直接写int字面量，也可以使用内置常量<code>http.Status*</code>（使用const实现）</p><p><img src=/img/gin-production/image-20230114001217883.png alt=image-20230114001217883></p><h1 id=0x02-服务方式>0x02 服务方式</h1><h2 id=restful-api>RESTful API</h2><p>RESTful API使用不同的HTTP请求方式进行相应内容的隔离，不同的请求方式对应不同handler进行处理。</p><p>常见的HTTP请求方式：</p><ul><li>GET</li><li>POST</li><li>PUT</li><li>DELETE</li></ul><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// RESTful API
</span></span></span><span style=display:flex><span><span style=color:#7f848e>// Use GET/POST/PUT/DELETE to isolate operations
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/hello&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;GET /hello&#34;</span>})
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>POST</span>(<span style=color:#98c379>&#34;/hello&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>c</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>c</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;POST /hello&#34;</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h2 id=返回静态页面>返回静态页面</h2><p>加载模板HTML文件：</p><ol><li><p>使用通配符进行对文件夹下所有HTML全局加载</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>LoadHTMLGlob</span>(<span style=color:#98c379>&#34;./resources/*&#34;</span>)
</span></span></code></pre></div><p>在参数中给出相对路径即可</p></li><li><p>显性写出文件名，单个文件加载</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>LoadHTMLFiles</span>(<span style=color:#98c379>&#34;./resources/index.html&#34;</span>)
</span></span></code></pre></div><p>参数中需要显式写出所有需要加载的HTML文件的文件名。函数接收的参数为<code>(files ...string)</code>，接收不定长度参数，可以同时传入多个文件进行处理：</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>LoadHTMLFiles</span>(<span style=color:#98c379>&#34;./resources/index1.html&#34;</span>,<span style=color:#98c379>&#34;./resources/index2.html&#34;</span>,<span style=color:#98c379>&#34;./resources/index3.html&#34;</span>)
</span></span></code></pre></div></li></ol><blockquote><p>为什么之前说是“模板”HTML？</p></blockquote><ul><li>可以在返回静态页面时，向页面动态传递数据，类似php/jsp的行为。</li></ul><p>向HTML传递参数：</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// GET /index
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/index&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>c</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>c</span>.<span style=color:#61afef;font-weight:700>HTML</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#98c379>&#34;index.html&#34;</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;title&#34;</span>: <span style=color:#98c379>&#34;Value of title&#34;</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>使用<code>ctx.HTML(code int, name string, obj any)</code>返回数据。Gin的HTML Renderer会将obj类型在HTML中进行预渲染。</p><p>这里使用了一个自定义类型<code>gin.H</code>，为<code>map[string]any</code>的别名，可以存储k-v键值对，用来存储序列化数据如JSON等。</p><p>如果不需要传输数据的时候，参数值赋<code>nil</code>。</p><p>在HTML文件中使用模板语句传递参数。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>meta</span> <span style=color:#e06c75>charset</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>title</span>&gt;{{.title}}&lt;/<span style=color:#e06c75>title</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>link</span> <span style=color:#e06c75>rel</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;stylesheet&#34;</span> <span style=color:#e06c75>href</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;res/style.css&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>script</span> <span style=color:#e06c75>src</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;res/common.js&#34;</span>&gt;&lt;/<span style=color:#e06c75>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>head</span>&gt;
</span></span></code></pre></div><p>其中，<code>{{.title}}</code>会在预渲染阶段替换为传递的<code>gin.H{"title": "Value of title"}</code>的内容，</p><p>渲染结果：</p><p><img src=/img/gin-production/image-20230113223500344.png alt=image-20230113223500344></p><p>加载HTML中的静态文件：</p><p>使用Gin对外提供服务时，需要解析静态文件并做路径的转化。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Load Resources File
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>Static</span>(<span style=color:#98c379>&#34;/res&#34;</span>, <span style=color:#98c379>&#34;./resources&#34;</span>)
</span></span></code></pre></div><p>Static函数原型：</p><p><code>func (group *RouterGroup) Static(relativePath, root string) IRoutes</code></p><p>可见，Static函数将root绝对路径转化为相对程序的relativePath，Gin到相对程序的relativePath去寻找静态文件。</p><p>程序目录结构如下：</p><p><img src=/img/gin-production/image-20230113223900563.png alt=image-20230113223900563></p><p>Gin将文件路径<code>./resources</code>转化为网页中<code>res/</code>并对外提供服务。</p><h1 id=0x03-参数传递>0x03 参数传递</h1><h2 id=问号传参>问号传参</h2><p>问号传参使用的方式为<code>GET</code>方式的请求，请求格式为<code>http://addr:port/interface?param1=xxx&param2=xxx</code>，使用<code>?</code>传入第一个参数，随后的参数使用<code>&</code>进行拼接。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// 1. Use ? and &amp; to pass params
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/user/info&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>userid</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Query</span>(<span style=color:#98c379>&#34;userid&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>username</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Query</span>(<span style=color:#98c379>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;userid&#34;</span>: <span style=color:#e06c75>userid</span>, <span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>username</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>使用<code>ctx.Query</code>解析传入的请求地址中的参数。</p><h2 id=restful-api-1>RESTful API</h2><p>RESTful API传入参数的方式为直接使用<code>/</code>分割。如接口<code>/user/info/:username/:userid</code>在请求时就是<code>/user/info/testuser/114514</code>。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// 2. RESTful /user/info/:username/:userid
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/user/info/:username/:userid&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>username</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Param</span>(<span style=color:#98c379>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>userid</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Param</span>(<span style=color:#98c379>&#34;userid&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;userid&#34;</span>: <span style=color:#e06c75>userid</span>, <span style=color:#98c379>&#34;username&#34;</span>: <span style=color:#e06c75>username</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>在创建解析RESTful API的接口时，使用<code>:param</code>作为占位，标定<code>param</code>在请求地址中的位置。使用<code>ctx.Param</code>解析传入的参数。</p><h2 id=序列化对象>序列化对象</h2><p>在前后端分离的项目中，常用的模式是前后端之间使用JSON进行数据的交换。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// 3. Serialized params (pass JSON to backend)
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>POST</span>(<span style=color:#98c379>&#34;/user/info&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// return byte[],err
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>data</span>, <span style=color:#e06c75>_</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>GetRawData</span>()
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// same as map[string]interface{}/map[string]any
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>var</span> <span style=color:#e06c75>m</span> <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// Parse JSON to map
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>_</span> = <span style=color:#e06c75>json</span>.<span style=color:#61afef;font-weight:700>Unmarshal</span>(<span style=color:#e06c75>data</span>, <span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>m</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>m</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>由于是已经序列化的对象，只能使用<code>ctx.GetRawData()</code>获取到切片格式<code>byte[]</code>。</p><p>后续再用内置的json方法<code>json.Unmarshal()</code>将切片转回Go对象的内置格式</p><p>函数原型：<code>func Unmarshal(data []byte, v any) error</code></p><p>函数接受切片data，以及指针v，反序列化后的内容存储在v中。</p><p>如果v不为指针或为<code>nil</code>，抛出<code>InvalidUnmarshalError</code>的Exception。</p><p>这里仍然使用<code>map[string]any</code>，即<code>map[k]v</code>，用来承接JSON转化为内置对象后的键值对格式。</p><h2 id=post表单>POST表单</h2><p>前端通过表单格式向后端发送表单格式的数据，也可以使用Gin进行处理</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// 4. Form params
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>POST</span>(<span style=color:#98c379>&#34;/user/form&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#e06c75>username</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>PostForm</span>(<span style=color:#98c379>&#34;name&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>age</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>PostForm</span>(<span style=color:#98c379>&#34;age&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;name&#34;</span>: <span style=color:#e06c75>username</span>, <span style=color:#98c379>&#34;age&#34;</span>: <span style=color:#e06c75>age</span>})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>HTML的表单设计：</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#e06c75>form</span> <span style=color:#e06c75>action</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;/user/form&#34;</span> <span style=color:#e06c75>method</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;post&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>label</span>&gt;Name&lt;/<span style=color:#e06c75>label</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>input</span> <span style=color:#e06c75>type</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;text&#34;</span> <span style=color:#e06c75>name</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;name&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>label</span>&gt;Age&lt;/<span style=color:#e06c75>label</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>input</span> <span style=color:#e06c75>type</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;number&#34;</span> <span style=color:#e06c75>name</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;age&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#e06c75>input</span> <span style=color:#e06c75>type</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;submit&#34;</span> <span style=color:#e06c75>value</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;Submit&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#e06c75>form</span>&gt;
</span></span></code></pre></div><p>元素使用<code>name</code>属性进行标记，在Gin的处理中使用<code>ctx.PostForm</code>解析。</p><h1 id=0x04-重定向>0x04 重定向</h1><p>使用301/302对请求进行重定向。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/test&#34;</span>, <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// Redirect
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Redirect</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusMovedPermanently</span>, <span style=color:#98c379>&#34;https://ishirai.com&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>为了实现跳转功能，HTTP状态码这里设置为<code>301 Moved Permanently</code>。跳转由浏览器实现，当浏览器请求到301状态码时，浏览器自动跟随跳转到下一个页面。</p><h1 id=0x05-404页面>0x05 404页面</h1><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// 404
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>NoRoute</span>(<span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>HTML</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusNotFound</span>, <span style=color:#98c379>&#34;404.html&#34;</span>, <span style=color:#e5c07b>nil</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>使用<code>server.NoRoute</code>对没有目标路由的页面做统一操作。这里是以404状态码返回了404页面，也可以在这里做一些其他的操作。</p><h1 id=0x06-路由组>0x06 路由组</h1><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>userGroup</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>Group</span>(<span style=color:#98c379>&#34;/user&#34;</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e06c75>userGroup</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/add&#34;</span>, <span style=color:#61afef;font-weight:700>myMiddleware</span>(), <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;add&#34;</span>})
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用<code>server.Group(path)</code>创建路由组，在路由组中创建的路由，会自动与路由组的<code>path</code>路径进行拼接。如上的路由最终请求地址就是<code>/user/add</code>。</p><h1 id=0x07-中间件>0x07 中间件</h1><p>Gin中的中间件和Java中的拦截器功能类似，用于在请求到达最终响应的handler之前，做一些预处理工作。比如设置全局变量，用户鉴权等工作。</p><p>Gin中的自定义中间件为<code>gin.HandlerFunc</code>类型，其原型为<code>func(*Context)</code>。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Middleware
</span></span></span><span style=display:flex><span><span style=color:#7f848e>// Clousure
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>myMiddleware</span>() <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;myMiddleware1,ctx====&gt;&#34;</span>, <span style=color:#e06c75>context</span>)
</span></span><span style=display:flex><span>		<span style=color:#7f848e>// Set global variable in middleware context
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Set</span>(<span style=color:#98c379>&#34;key&#34;</span>, <span style=color:#98c379>&#34;value&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Next</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Direct
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>myMiddleware2</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;myMiddleware2,ctx====&gt;&#34;</span>, <span style=color:#e06c75>context</span>)
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// Set global variable in middleware context
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>	<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Set</span>(<span style=color:#98c379>&#34;key&#34;</span>, <span style=color:#98c379>&#34;value&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Next</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>中间件可以采用闭包的形式，返回一个函数，如<code>myMiddleware</code>的实现。或者直接定义<code>gin.HandlerFunc</code>类型的函数都可以实现。</p><p>闭包形式的写法，可以看出函数的类型为<code>HandlerFunc</code>，而直接定义看不出函数类型，且闭包写法可以使用闭包的特性。</p><p>针对使用中间件的范围，有三种写法：</p><ol><li><p>仅在当前的路由中使用中间件</p><p><code>server.METHOD("/path", myMiddleware1(), ...handlers HandlerFunc)</code></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Closure
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/test&#34;</span>, <span style=color:#61afef;font-weight:700>myMiddleware1</span>() ,<span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {<span style=color:#56b6c2>...</span>})
</span></span><span style=display:flex><span><span style=color:#7f848e>// Direct
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>ginServer</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/test&#34;</span>, <span style=color:#e06c75>myMiddleware1</span> ,<span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {<span style=color:#56b6c2>...</span>})
</span></span></code></pre></div></li><li><p>在当前路由组中使用中间件</p><p>在定义路由组的时候，将中间件作为参数传入。</p><p><code>server.Group("/path", myMiddleware1()){...Handlers}</code></p></li><li><p>全局使用中间件</p><p><code>server.Use(myMiddleware())</code></p></li></ol><p>在中间件中，可以使用<code>ctx.Set(k,v)</code>设置全局变量，经过中间件设置的全局变量，在后续的处理中也是可见的。可以使用<code>ctx.Get(k)</code>获取到键值对的值v。也可以用<code>ctx.MustGet(k)</code>，当key不存在时，产生panic。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>userGroup</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/add&#34;</span>, <span style=color:#61afef;font-weight:700>myMiddleware1</span>(), <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// Print global variable in log
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;key:=====&gt;&#34;</span>, <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>MustGet</span>(<span style=color:#98c379>&#34;key&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;add&#34;</span>, <span style=color:#98c379>&#34;key&#34;</span>: <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>MustGet</span>(<span style=color:#98c379>&#34;key&#34;</span>)})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>在中间件中可以进行流程控制。</p><p>使用<code>ctx.Next()</code>可以执行下一个handler，下一个handler执行后，再返回此处继续执行剩下的代码，可以用来做<code>post-run</code>的操作。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Middleware
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>myMiddleware</span>() <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#7f848e>// Set global variable in middleware context
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Set</span>(<span style=color:#98c379>&#34;key&#34;</span>, <span style=color:#98c379>&#34;value&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;before&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Next</span>()
</span></span><span style=display:flex><span>		<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;after&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>userGroup</span>.<span style=color:#61afef;font-weight:700>GET</span>(<span style=color:#98c379>&#34;/add&#34;</span>, <span style=color:#61afef;font-weight:700>myMiddleware</span>(), <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// Print global variable in log
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;next handler&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>JSON</span>(<span style=color:#e06c75>http</span>.<span style=color:#e06c75>StatusOK</span>, <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>H</span>{<span style=color:#98c379>&#34;msg&#34;</span>: <span style=color:#98c379>&#34;add&#34;</span>, <span style=color:#98c379>&#34;key&#34;</span>: <span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>MustGet</span>(<span style=color:#98c379>&#34;key&#34;</span>)})
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><img src=/img/gin-production/image-20230113234430327.png alt=image-20230113234430327></p><p>使用<code>ctx.Abort()</code>可以中断操作。</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Middleware
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>myMiddleware</span>() <span style=color:#e06c75>gin</span>.<span style=color:#e06c75>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#c678dd>func</span>(<span style=color:#e06c75>context</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>gin</span>.<span style=color:#e06c75>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#7f848e>// Set global variable in middleware context
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Set</span>(<span style=color:#98c379>&#34;key&#34;</span>, <span style=color:#98c379>&#34;value&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;before&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>context</span>.<span style=color:#61afef;font-weight:700>Abort</span>()
</span></span><span style=display:flex><span>		<span style=color:#e06c75>log</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#98c379>&#34;after&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/img/gin-production/image-20230113234545704.png alt=image-20230113234545704></p><p>对于可以进行嵌套的链式操作，使用<code>ctx.Abort()</code>可以跳过后续handler的执行，直接执行Abort后的函数语句。</p><p>关于<code>ctx.Abort()</code>的变种，还有<code>ctx.Abort()/ctx.AbortWithStatus()/ctx.AbortWithStatusJSON()</code>等。可以实现带返回值的Abort和Abort后同时有返回值和JSON消息等操作。</p><hr width=100% id=EOF><p style=color:#777>最后修改于 2023-01-14</p></div></div><nav class=post-pagination><a class=newer-posts>下回<br>已经到头啦。</a>
<a class=older-posts>上回<br>这是最旧的文章了。</a></nav><div class=post-comment-wrapper><script src=https://utteranc.es/client.js repo=kirakiseki/blog issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Ishirai CC-BY-NC 4.0</div></div><script src=/js/journal.js></script></body></html>